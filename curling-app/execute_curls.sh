#!/bin/sh

# target URL
TARGET="${TARGET_URL:-http://localhost:3000}"

# sample json
json_data=$(cat <<EOF
{
  "json": {
    "places": [
      {
        "name": "pyrenees",
        "animal": [
          { "name": "brown bear", "food": ["berries", "fish", "honey"] },
          { "name": "iberian wolf", "food": ["deer", "wild boar", "rabbit"] },
          { "name": "vulture", "food": ["carrion", "small mammals"] }
        ]
      },
      {
        "name": "alps",
        "animal": [
          { "name": "marmot", "food": ["grass", "roots", "flowers"] },
          { "name": "ibex", "food": ["leaves", "grass", "shrubs"] },
          { "name": "golden eagle", "food": ["small mammals", "birds"] }
        ]
      },
      {
        "name": "himalayas",
        "animal": [
          { "name": "snow leopard", "food": ["mountain goats", "meat", "birds"] },
          { "name": "yak", "food": ["grass", "alpine plants"] },
          { "name": "red panda", "food": ["bamboo", "fruits", "berries"] }
        ]
      }
    ]
  }
}
EOF
)

# array of JSONPath queries and natural languaje explanations
queries=(
    "$.places[*].name|Retrieve the names of all places in the JSON."
    "$.places[?(@.name == 'alps')].animal[*].name|Retrieve all animals specifically in the 'alps' location."
    "$.places[*].animal[?(@.name == 'yak')].food|Get the list of foods for animals named 'yak' across all places."
    "$.places[*].animal[*].food[*]|List every individual food item across all animals and places."
    "$.places[*].animal[?(@.food contains 'grass')].name|Identify animals that eat 'grass' across all places."
    "$.places[?(@.name == 'himalayas')].animal[*]|Retrieve full details of each animal in the 'himalayas'."
    "$.places[*].animal[*].name|Return the names of all animals, regardless of location."
)

# Run forever
while true; do
    # Select a random query from the array
    random_index=$((RANDOM % ${#queries[@]}))
    
    # Split the selected item into query and explanation
    IFS="|" read -r query explanation <<< "${queries[$random_index]}"

    # Print the explanation
    echo "$explanation"

    # Execute the curl command with the selected query
    curl -s -X POST "$TARGET/query" -H "Content-Type: application/json" \
    -d "$(echo "$json_data" | jq --arg path "$query" '. + {path: $path}')" | jq .response.result

    # Wait for a random duration between 5 to 10 seconds
    sleep $((5 + RANDOM % 6))
done
